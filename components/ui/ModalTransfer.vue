<template>
  <Modal
    ref="modal"
    :header="'Transfer to ' + formatWallet(wallet)"
    :noblur="!(cosmetics.advancedRendering ?? true)"
  >
    <div class="modal-transfer">
      <span
        >You are initiating a transfer of your revenue from Modrinth's Creator Monetization Program.
        How much of your <strong>{{ formatMoney(balance) }}</strong> balance would you like to
        transfer?</span
      >
      <div class="confirmation-input">
        <input
          id="confirmation"
          v-model="amount"
          type="text"
          pattern="^\d*(\.\d{0,2})?$"
          autocomplete="off"
          placeholder="Amount to transfer..."
        />
      </div>
      <div class="confirm-text">
        <Checkbox
          v-if="isValidInput() && parseInput() >= minWithdraw && parseInput() <= balance"
          v-model="consentedFee"
          description="Consent to fee"
        >
          <template v-if="wallet === 'venmo'">
            I acknowledge that $0.25 will be deducted from the amount I receive to cover
            {{ formatWallet(wallet) }} processing fees.
          </template>
          <template v-else>
            I acknowledge that an estimated
            {{ formatMoney(calcProcessingFees()) }} will be deducted from the amount I receive to
            cover {{ formatWallet(wallet) }} processing fees and that any excess will be returned to
            my Modrinth balance.
          </template>
        </Checkbox>
        <Checkbox
          v-if="isValidInput() && parseInput() >= minWithdraw && parseInput() <= balance"
          v-model="consentedAccount"
          description="Confirm transfer"
        >
          I confirm that I an initiating a transfer to the following
          {{ formatWallet(wallet) }} account: {{ account }}
        </Checkbox>
        <span v-else-if="validInput && parseInput() < minWithdraw" class="invalid">
          The amount must be at least {{ formatMoney(minWithdraw) }}</span
        >
        <span v-else-if="validInput && parseInput() > balance" class="invalid">
          The amount must be no more than {{ formatMoney(balance) }}</span
        >
        <span v-else-if="amount.length > 0" class="invalid">
          {{ amount }} is not a valid amount</span
        >
      </div>
      <div class="input-group push-right">
        <NuxtLink class="btn" to="/settings/monetization">
          <SettingsIcon /> Monetization settings
        </NuxtLink>
        <button class="btn" @click="cancel">
          <XIcon />
          Cancel
        </button>
        <button
          class="btn btn-primary"
          :disabled="!consentedFee || !consentedAccount"
          @click="proceed"
        >
          <TransferIcon />
          Transfer
        </button>
      </div>
    </div>
  </Modal>
</template>

<script>
import {
  SettingsIcon,
  TransferIcon,
  XIcon,
  Modal,
  Checkbox,
  formatMoney,
  formatWallet,
} from 'omorphia'

export default {
  components: {
    Checkbox,
    XIcon,
    SettingsIcon,
    TransferIcon,
    Modal,
  },
  props: {
    wallet: {
      type: String,
      required: true,
    },
    accountType: {
      type: String,
      required: true,
    },
    account: {
      type: String,
      required: true,
    },
    balance: {
      type: Number,
      required: true,
    },
    minWithdraw: {
      type: Number,
      required: true,
    },
  },
  setup() {
    const cosmetics = useCosmetics()
    return {
      cosmetics,
    }
  },
  data() {
    return {
      consentedFee: false,
      consentedAccount: false,
      amount: '',
      validInput: false,
    }
  },
  methods: {
    formatWallet,
    formatMoney,
    cancel() {
      this.amount = ''
      this.consentedFee = false
      this.consentedAccount = false
      this.validInput = false
      this.$refs.modal.hide()
    },
    async proceed() {
      startLoading()
      try {
        const auth = await useAuth()

        await useBaseFetch(`user/${auth.value.user.id}/payouts`, {
          method: 'POST',
          body: {
            amount: Number(this.amount.replace('$', '')),
          },
        })
        await useAuth(auth.value.token)

        this.$refs.modal.hide()
      } catch (err) {
        addNotification({
          group: 'main',
          title: 'An error occurred',
          text: err.data.description,
          type: 'error',
        })
      }
      stopLoading()
    },
    show() {
      this.$refs.modal.show()
    },
    isValidInput() {
      const regex = /^\$?(\d*(\.\d{2})?)$/gm
      this.validInput = regex.test(this.amount) && this.amount.length > 0
      return this.validInput
    },
    parseInput() {
      const regex = /^\$?(\d*(\.\d{2})?)$/gm
      const matches = regex.exec(this.amount)
      return parseFloat(matches[1])
    },
    calcProcessingFees() {
      if (this.wallet === 'venmo') {
        return 0.25
      } else {
        return Math.max(0.25, Math.min(this.parseInput() * 0.02, 20))
      }
    },
  },
}
</script>

<style scoped lang="scss">
.modal-transfer {
  padding: var(--gap-lg);
  display: flex;
  flex-direction: column;
  gap: var(--gap-sm);

  .confirmation-input {
    input {
      width: 14rem;
      max-width: 100%;
    }
  }

  strong {
    color: var(--color-contrast);
    font-weight: 500;
  }

  .invalid {
    color: var(--color-red);
  }

  .confirm-text {
    margin-top: var(--gap-sm);
    min-height: 7rem;
    display: flex;
    flex-direction: column;
    gap: var(--gap-sm);
  }
}
</style>
