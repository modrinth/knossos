<template>
  <div>
    <section class="card">
      <div class="label">
        <h3>
          <span class="label__title size-card-header">Tags</span>
        </h3>
      </div>
      <p>
        Accurate tagging is important to help people find your
        {{ formatProjectType(project.project_type).toLowerCase() }}. Make sure to select all tags
        that apply.
      </p>
      <template v-for="header in Object.keys(categoryLists)" :key="`categories-${header}`">
        <div class="label">
          <h4>
            <span class="label__title">{{ formatCategoryHeader(header) }}</span>
          </h4>
          <span class="label__description">
            <template v-if="header === 'categories'">
              Select all categories that reflect the themes or function of your
              {{ formatProjectType(project.project_type).toLowerCase() }}.
            </template>
            <template v-else-if="header === 'features'">
              Select all of the features that your
              {{ formatProjectType(project.project_type).toLowerCase() }} makes use of.
            </template>
            <template v-else-if="header === 'resolutions'">
              Select the resolution(s) of textures in your
              {{ formatProjectType(project.project_type).toLowerCase() }}.
            </template>
            <template v-else-if="header === 'performance impact'">
              Select the realistic performance impact of your
              {{ formatProjectType(project.project_type).toLowerCase() }}. Select multiple if the
              {{ formatProjectType(project.project_type).toLowerCase() }} is configurable to
              different levels of performance impact.
            </template>
          </span>
        </div>
        <div class="category-list input-div">
          <Checkbox
            v-for="category in categoryLists[header]"
            :key="`category-${header}-${category.name}`"
            :model-value="selectedTags.includes(category)"
            :description="formatCategory(category.name)"
            class="category-selector"
            @update:model-value="toggleCategory(category)"
          >
            <div class="category-selector__label">
              <div
                v-if="header !== 'resolutions' && category.icon"
                aria-hidden="true"
                class="icon"
                v-html="category.icon"
              />
              <span aria-hidden="true"> {{ formatCategory(category.name) }}</span>
            </div>
          </Checkbox>
        </div>
      </template>
      <div class="label">
        <h4>
          <span class="label__title"><StarIcon /> Featured tags</span>
        </h4>
        <span class="label__description">
          You can feature up to 3 of your most relevant tags. Other tags may be promoted to featured
          if you do not select all 3.
        </span>
      </div>
      <p v-if="selectedTags.length < 1">
        Select at least one category in order to feature a category.
      </p>
      <div class="category-list input-div">
        <Checkbox
          v-for="category in selectedTags"
          :key="`featured-category-${category.name}`"
          class="category-selector"
          :model-value="featuredTags.includes(category)"
          :description="formatCategory(category.name)"
          :disabled="featuredTags.length >= 3 && !featuredTags.includes(category)"
          @update:model-value="toggleFeaturedCategory(category)"
        >
          <div class="category-selector__label">
            <div
              v-if="category.header !== 'resolutions' && category.icon"
              aria-hidden="true"
              class="icon"
              v-html="category.icon"
            />
            <span aria-hidden="true"> {{ formatCategory(category.name) }}</span>
          </div>
        </Checkbox>
      </div>
      <div class="input-group">
        <button
          type="button"
          class="btn btn-primary"
          :disabled="!hasChanges"
          @click="saveChanges()"
        >
          <SaveIcon />
          Save changes
        </button>
      </div>
    </section>
  </div>
</template>

<script setup>
import {
  Checkbox,
  StarIcon,
  SaveIcon,
  formatProjectType,
  formatCategory,
  formatCategoryHeader,
} from 'omorphia'

definePageMeta({
  middleware: 'auth',
})

const props = defineProps({
  project: {
    type: Object,
    default() {
      return {}
    },
  },
  allMembers: {
    type: Array,
    default() {
      return []
    },
  },
  currentMember: {
    type: Object,
    default() {
      return null
    },
  },
  patchProject: {
    type: Function,
    default() {
      return () => {
        addNotification({
          group: 'main',
          title: 'An error occurred',
          text: 'Patch project function not found',
          type: 'error',
        })
      }
    },
  },
})

const selectedTags = ref(
  sortedCategories().filter(
    (x) =>
      x.project_type === props.project.actualProjectType &&
      (props.project.categories.includes(x.name) ||
        props.project.additional_categories.includes(x.name))
  )
)
const featuredTags = ref(
  sortedCategories().filter(
    (x) =>
      x.project_type === props.project.actualProjectType &&
      props.project.categories.includes(x.name)
  )
)

const categoryLists = computed(() => {
  const lists = {}
  sortedCategories().forEach((x) => {
    if (x.project_type === props.project.actualProjectType) {
      const header = x.header
      if (!lists[header]) {
        lists[header] = []
      }
      lists[header].push(x)
    }
  })
  return lists
})

const patchData = computed(() => {
  const data = {}
  // Promote selected categories to featured if there are less than 3 featured
  const newFeaturedTags = featuredTags.value.slice()
  if (newFeaturedTags.length < 1 && selectedTags.value.length > newFeaturedTags.length) {
    const nonFeaturedCategories = selectedTags.value.filter((x) => !newFeaturedTags.includes(x))

    nonFeaturedCategories
      .slice(0, Math.min(nonFeaturedCategories.length, 3 - newFeaturedTags.length))
      .forEach((x) => newFeaturedTags.push(x))
  }
  // Convert selected and featured categories to backend-usable arrays
  const categories = newFeaturedTags.map((x) => x.name)
  const additionalCategories = selectedTags.value
    .filter((x) => !newFeaturedTags.includes(x))
    .map((x) => x.name)

  if (
    categories.length !== props.project.categories.length ||
    categories.some((value) => !props.project.categories.includes(value))
  ) {
    data.categories = categories
  }

  if (
    additionalCategories.length !== props.project.additional_categories.length ||
    additionalCategories.some((value) => !props.project.additional_categories.includes(value))
  ) {
    data.additional_categories = additionalCategories
  }

  return data
})

const hasChanges = computed(() => Object.keys(patchData.value).length > 0)

function toggleCategory(category) {
  if (selectedTags.value.includes(category)) {
    selectedTags.value = selectedTags.value.filter((x) => x !== category)
    if (featuredTags.value.includes(category)) {
      featuredTags.value = featuredTags.value.filter((x) => x !== category)
    }
  } else {
    selectedTags.value.push(category)
  }
}

function toggleFeaturedCategory(category) {
  if (featuredTags.value.includes(category)) {
    featuredTags.value = featuredTags.value.filter((x) => x !== category)
  } else {
    featuredTags.value.push(category)
  }
}

function saveChanges() {
  if (hasChanges.value) {
    props.patchProject(patchData.value)
  }
}
</script>
<style lang="scss" scoped>
.label__title {
  margin-top: var(--gap-lg);

  svg {
    vertical-align: top;
  }
}

.category-list {
  column-count: 4;
  column-gap: var(--gap-xl);
  margin-bottom: var(--gap-md);

  :deep(.category-selector) {
    margin-bottom: 0.5rem;
    .category-selector__label {
      display: flex;
      align-items: center;
      .icon {
        height: 1rem;
        svg {
          margin-right: 0.25rem;
          width: 1rem;
          height: 1rem;
        }
      }
    }
    span {
      user-select: none;
    }
  }

  @media only screen and (max-width: 1250px) {
    column-count: 3;
  }
  @media only screen and (max-width: 1024px) {
    column-count: 4;
  }
  @media only screen and (max-width: 960px) {
    column-count: 3;
  }
  @media only screen and (max-width: 750px) {
    column-count: 2;
  }
  @media only screen and (max-width: 530px) {
    column-count: 1;
  }
}
</style>
